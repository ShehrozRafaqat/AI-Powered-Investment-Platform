<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="A stock prediction platform with sentiment analysis and predictive modeling."
    />
    <meta name="author" content="Investment Platform" />
    <title>Stock Prediction</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/static/css/styleprediction.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  </head>
  <body>
     <!-- Loading Animation -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-container">
          <img src="/static/images/stck.gif" alt="Loading..." class="loading-gif" />
          <p class="loading-text">Processing prediction...</p>
      </div>
    </div>

    <style>
      .loading-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(255, 255, 255, 0.8);
          backdrop-filter: blur(5px);
          -webkit-backdrop-filter: blur(5px);
          display: none;
          justify-content: center;
          align-items: center;
          z-index: 2000;
      }

      .loading-container {
          display: flex;
          flex-direction: column;
          align-items: center;
          background-color: white;
          padding: 40px;
          border-radius: 12px;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
          min-width: 200px;
      }

      .loading-gif {
          width: 120px;
          height: 120px;
          margin-bottom: 20px;
          border-radius: 12px;
          object-fit: cover;
      }

      .loading-text {
          color: #333;
          font-size: 20px;
          margin: 0;
          font-weight: 500;
      }

      .body-blur {
          overflow: hidden;
      }
      body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #2c3e50;
        }
      .navbar {
            background: linear-gradient(135deg, #2c3e50 0%, #1a252f 100%);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
      .nav-links a {
            color: white !important;
            margin: 0 15px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
      .nav-links a:hover {
            color: #7830de !important;
            transform: translateY(-2px);
        }

      .brand {
            color: white !important;
            font-weight: 600;
            letter-spacing: 1px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
      .brand i {
          font-size: 1.8rem;
          color: #7830de;
      }
      .prediction-form-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(0, 0, 0, 0.05);
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            margin-top: 2rem;
        }

      .form-control {
            border: none;
            border-radius: 10px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

      .form-control:focus {
            box-shadow: 0 0 0 2px #4a90e2;
            border-color: transparent;
        }

      .form-control:hover {
          transform: translateY(-1px);
      }
      .btn-primary {
            background: linear-gradient(135deg, #7830de 0%, #21024d 100%);
            border: none;
            border-radius: 10px;
            padding: 12px 30px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px #985cec;
        }

      .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px #5a358d;
        }

      .model-description {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-left: 4px solid #7830de;
        }

      .prediction-summary {
            background: linear-gradient(135deg, #e9f7ef 0%, #d4edda 100%);
            border-left: 4px solid #401281;
        }

      .ticker-badge {
            background: linear-gradient(135deg, #343a40 0%, #23272b 100%);
        }

      .table-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

      .plots-container {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

      .loading-container {
            background: linear-gradient(135deg, #ffffff 0%, #f0f2f5 100%);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

      .loading-text {
            color: #7830de;
            animation: pulse 1.5s infinite;
        }

      @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }
    </style>
    
    <nav class="navbar">
      <div class="container">
        <h1 class="brand">Investment Platform</h1>
        <ul class="nav-links">
          <li><a href="/">Dashboard</a></li>
          <li><a href="/logout">Log Out</a></li>
        </ul>
      </div>
    </nav>

    <section class="dashboard">
      <div class="container">
        <h2>Stock Prediction</h2>

        {% if error %}
        <div class="alert alert-danger">
          {% if error_message %}
            {{ error_message }}
          {% else %}
            An error occurred during prediction. Please try again.
          {% endif %}
        </div>
        {% endif %}

        <div class="prediction-form-container">
          <form id="predictionForm" method="POST" action="{{ url_for('predict_stock') }}">
            <div class="form-group">
              <label for="model_type">Select Prediction Model:</label>
              <select
                name="model_type"
                id="model_type"
                class="form-control"
                required
              >
                <option value="Logistic Regression">Logistic Regression</option>
                <option value="Linear Regression">Linear Regression</option>
                <option value="LSTM">LSTM</option>
              </select>
            </div>

            <div id="modelDescription" class="model-description" style="display: none;">
              <h4>Model Information</h4>
              <div id="lstmInfo" style="display: none;">
                <p>The LSTM (Long Short-Term Memory) model is a deep learning approach that:</p>
                <ul>
                  <li>Uses past stock price patterns to predict future prices</li>
                  <li>Excels at capturing long-term dependencies in time series data</li>
                  <li>Provides predictions for the next 7 trading days</li>
                  <li>Evaluates performance using Root Mean Square Error (RMSE)</li>
                </ul>
              </div>
              
              <div id="linearInfo" style="display: none;">
                <p>The Linear Regression model:</p>
                <ul>
                  <li>Combines sentiment analysis and technical indicators</li>
                  <li>Provides predictions for the next 7 days</li>
                  <li>Compares performance with LSTM for better insight</li>
                  <li>Offers a balanced approach between technical and fundamental analysis</li>
                </ul>
              </div>
              
              <div id="logisticInfo" style="display: none;">
                <p>The Logistic Regression model:</p>
                <ul>
                  <li>Predicts directional movement (up/down) rather than exact prices</li>
                  <li>Uses classification metrics to evaluate performance</li>
                  <li>Provides probability estimates for price movements</li>
                  <li>Ideal for trading strategies focused on market direction</li>
                </ul>
              </div>
            </div>

            <div class="form-group">
              <label for="tickers">Select Ticker for Prediction:</label>
              <select
                name="tickers"
                id="tickers"
                class="form-control"
                required
              >
                <option value="AMZN">AMZN</option>
                <option value="AAPL">AAPL</option>
                <option value="GOOGL">GOOGL</option>
                <option value="MSFT">MSFT</option>
                <option value="TSLA">TSLA</option>
              </select>
              <small class="form-text text-muted">For LSTM model, only one ticker can be selected at a time.</small>
            </div>

            <button type="submit" class="btn btn-primary btn-predict">
              Predict
            </button>
          </form>
        </div>

        {% if model_type %}
        <div class="prediction-summary">
          <h3>Prediction Results for <span class="ticker-badge">{{ ticker }}</span></h3>
          <p>Model: <strong>{{ model_type }}</strong></p>
        </div>
        {% endif %}
        
        {% if model_type == "Logistic Regression" %}
          {% if tables %}
            {% for ticker in tickers %}
            <div class="results-section">
              <h3>{{ ticker }} Prediction Results</h3>

              {% if plots and plots[ticker] %}
              <div class="plots-container">
                <div class="plot">
                  <h4>Price Movement Prediction</h4>
                  <img
                    src="data:image/png;base64,{{ plots[ticker]['prediction_plot'] }}"
                    alt="{{ ticker }} Prediction Plot"
                    class="img-fluid"
                  />
                </div>
                <div class="plot">
                  <h4>Classification Report</h4>
                  <img
                    src="data:image/png;base64,{{ plots[ticker]['report_plot'] }}"
                    alt="{{ ticker }} Classification Report"
                    class="img-fluid"
                  />
                </div>
              </div>
              {% endif %}

              <h4>Detailed Predictions</h4>
              <div class="table-container">
                <div class="table-responsive">{{ tables[ticker] | safe }}</div>
              </div>
            </div>
            {% endfor %}
          {% endif %}
        {% endif %}
        
        {% if model_type == "LSTM" %}
        <div class="results-section">
          <h3>{{ ticker }} LSTM Results</h3>
          
          {% if plot_url %}
          <div class="plots-container">
            <div class="plot">
              <h4>Historical Price Prediction</h4>
              <img
                src="data:image/png;base64,{{ plot_url }}"
                alt="LSTM Prediction Plot"
                class="img-fluid"
              />
              <p class="text-muted">Comparison of actual prices (blue) and model predictions (red)</p>
            </div>
          </div>
          {% endif %}
          
          {% if metrics_table %}
          <h4>Model Performance Metrics</h4>
          <div class="table-container">
            <div class="table-responsive">{{ metrics_table | safe }}</div>
          </div>
          {% endif %}
          
          {% if plot_loss_url %}
          <div class="plots-container">
            <div class="plot">
              <h4>Model Training Loss</h4>
              <img
                src="data:image/png;base64,{{ plot_loss_url }}"
                alt="LSTM Training Loss"
                class="img-fluid"
              />
              <p class="text-muted">Model training convergence over epochs</p>
            </div>
          </div>
          {% endif %}
          
          {% if next_7_days_table %}
          <h4>Next 7 Days Price Predictions</h4>
          <div class="table-container">
            <div class="table-responsive">{{ next_7_days_table | safe }}</div>
          </div>
          {% endif %}
          
          {% if plot_next_url %}
          <div class="plots-container">
            <div class="plot">
              <h4>Next 7 Days Prediction Visualization</h4>
              <img
                src="data:image/png;base64,{{ plot_next_url }}"
                alt="Next 7 Days Prediction Plot"
                class="img-fluid"
              />
              <p class="text-muted">Projected price movement for the next 7 trading days</p>
            </div>
          </div>
          {% endif %}
        </div>
        {% endif %}
        
        {% if model_type == "Linear Regression" %}
        <div class="results-section">
          <h3>{{ ticker }} Linear Regression Results</h3>
          
          {% if plot_combine_url %}
          <div class="plots-container">
            <div class="plot">
              <h4>Combined Prediction (Linear Regression + LSTM)</h4>
              <img
                src="data:image/png;base64,{{ plot_combine_url }}"
                alt="Combined Prediction Plot"
                class="img-fluid"
              />
            </div>
          </div>
          {% endif %}
          
          {% if l_table %}
          <h4>Final Prediction Results</h4>
          <div class="table-container">
            <div class="table-responsive">{{ l_table | safe }}</div>
          </div>
          {% endif %}
          
          <div class="plots-container">
            {% if plot_lstm_url %}
            <div class="plot">
              <h4>LSTM Component Analysis</h4>
              <img
                src="data:image/png;base64,{{ plot_lstm_url }}"
                alt="LSTM Prediction Plot"
                class="img-fluid"
              />
            </div>
            {% endif %}
            
            {% if plot_linear_url %}
            <div class="plot">
              <h4>Linear Regression Component Analysis</h4>
              <img
                src="data:image/png;base64,{{ plot_linear_url }}"
                alt="Linear Prediction Plot"
                class="img-fluid"
              />
            </div>
            {% endif %}
          </div>
          
          {% if plot_lstm_v_combine_url %}
          <div class="plots-container">
            <div class="plot">
              <h4>Model Comparison: Combined vs LSTM</h4>
              <img
                src="data:image/png;base64,{{ plot_lstm_v_combine_url }}"
                alt="Model Comparison Plot"
                class="img-fluid"
              />
            </div>
          </div>
          {% endif %}
        </div>
        {% endif %}
      </div>
    </section>
    <script>
    // Loading overlay functions
    function showLoading() {
        console.log('Showing loading overlay');
        const overlay = document.getElementById("loadingOverlay");
        const body = document.body;
        if (overlay) {
            overlay.style.display = "flex";
            body.classList.add("body-blur");
        }
    }

    function hideLoading() {
        console.log('Hiding loading overlay');
        const overlay = document.getElementById("loadingOverlay");
        const body = document.body;
        if (overlay) {
            overlay.style.display = "none";
            body.classList.remove("body-blur");
        }
    }

    // Wait for the document to be fully loaded
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM Content Loaded');
        
        // Get the form element
        const form = document.getElementById('predictionForm');
        const modelSelect = document.getElementById("model_type");
        const tickerSelect = document.getElementById("tickers");
        const modelDescription = document.getElementById("modelDescription");
        const lstmInfo = document.getElementById("lstmInfo");
        const linearInfo = document.getElementById("linearInfo");
        const logisticInfo = document.getElementById("logisticInfo");
        
        // Show appropriate model description when model type changes
        modelSelect.addEventListener("change", function() {
            modelDescription.style.display = "block";
            
            // Hide all model info sections first
            lstmInfo.style.display = "none";
            linearInfo.style.display = "none";
            logisticInfo.style.display = "none";
            
            // Show the appropriate section based on selection
            if (modelSelect.value === "LSTM") {
                lstmInfo.style.display = "block";
                // Update ticker select for LSTM (single select)
                tickerSelect.removeAttribute("multiple");
            } 
            else if (modelSelect.value === "Linear Regression") {
                linearInfo.style.display = "block";
                // Update ticker select for Linear Regression (can be multiple)
                tickerSelect.setAttribute("multiple", "");
            }
            else if (modelSelect.value === "Logistic Regression") {
                logisticInfo.style.display = "block";
                // Update ticker select for Logistic Regression (can be multiple)
                tickerSelect.setAttribute("multiple", "");
            }
        });
        
        // Initialize model description based on current selection
        if (modelSelect.value) {
            modelSelect.dispatchEvent(new Event('change'));
        }
        
        if (form) {
            console.log('Form found');
            
            form.addEventListener('submit', function(e) {
                console.log('Form submitted');
                
                // Get selected tickers
                const selectedTickers = tickerSelect.selectedOptions;
                
                // Validate ticker selection
                if (selectedTickers.length === 0) {
                    e.preventDefault();
                    alert('Please select at least one ticker to predict.');
                    return false;
                }
                
                // LSTM model can only handle one ticker at a time
                if (modelSelect.value === "LSTM" && selectedTickers.length > 1) {
                    e.preventDefault();
                    alert('LSTM model can only process one ticker at a time. Please select only one ticker.');
                    return false;
                }
                
                // If validation passes, show loading overlay
                showLoading();
                
                // Let the form submit normally
                return true;
            });
        } else {
            console.log('Form not found - check your form ID');
        }
    });
    </script>
    {% if tables or plots or plot_url or l_table or metrics_table or plot_next_url or plot_loss_url %}
    <script
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Results detected, hiding loading overlay');
        hideLoading();
    });
    </script>
    {% endif %}
  </body>
</html>